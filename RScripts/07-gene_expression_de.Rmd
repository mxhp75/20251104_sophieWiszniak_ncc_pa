---
title: "gene_expression_de"
author: "Melanie Smith"
date: "2025-12-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Clean-up environment

```{r}
rm(list = ls(all.names = TRUE)) # will clear all objects includuing hidden objects
gc() # free up memory and report the memory usage
options(max.print = .Machine$integer.max,
        scipen = 999,
        stringsAsFactors = FALSE,
        dplyr.summarise.inform = FALSE) # Print everything without truncation, avoid scientific notation, keep strings as characters, silence dplyr’s “grouped output” informational messages
set.seed(42) # set seed for reproducibility
```

# Load Libraries

```{r}
# Core tidyverse
library(tidyverse)
library(tibble)
library(dplyr)
library(tidyr)

# Single Cell
library(Seurat) # Seurat (relies on dplyr/tidyr, so load after tidyverse)

library(SingleCellExperiment)
library(biomaRt)
library(scuttle)

# additional plotting functions
library(patchwork)
library(pheatmap)
```

# Set project directories and file paths

```{r}
project_name <- "20251104_sophieWiszniak_ncc_pa"

base_repo_dir <- "/home/melanie-smith/workDir/sophieWiszniak"
project_repo_dir <- file.path(base_repo_dir, project_name)
data_base_dir <- file.path(project_repo_dir, "rawData")
filtered_dir <- file.path(project_repo_dir, "outDir", "05-secondary_QC")
out_dir <- file.path(project_repo_dir, "outDir", "07-gene_expression_de")
# Create directory if it doesn't exist
if (!dir.exists(out_dir)) {
  dir.create(out_dir, recursive = TRUE)
}
```

# Load required objects
- This object has been filtered for doublets and >10% MT genes

```{r}
re_embed_interesting_cells <- readRDS(file.path("~/workDir/sophieWiszniak/20251104_sophieWiszniak_ncc_pa", "outDir",  "06-cluster_marker_genes", "final_interesting_cells_0.6.rds"))
# Ensure seurat_custers is the active identity
Idents(re_embed_interesting_cells) <- "seurat_clusters"

```

# DE

```{r}

# for a cell-type, what's the difference between proportions between time points
re_embed_interesting_cells$celltype.cond <- paste(re_embed_interesting_cells$new_celltypes,
                                                  re_embed_interesting_cells$orig.ident,
                                                  sep = "_")
```

## Mesenchyme

```{r}
Idents(re_embed_interesting_cells) <- "celltype.cond"


control.mesenchyme.de <- FindMarkers(re_embed_interesting_cells,
                             ident.1 = "Mesenchyme_e11_control",
                             ident.2 = "Mesenchyme_e12_control",
                             verbose = FALSE)

arrange(control.mesenchyme.de, desc(abs(avg_log2FC))) %>% as_tibble(rownames = "gene")

mesenchyme_de <- control.mesenchyme.de %>%
  rownames_to_column("gene") %>%
  mutate(
    neg_log10_padj = -log10(p_val_adj),
    sig = case_when(
      p_val_adj < 0.05 & avg_log2FC >  0.25 ~ "Up in e11",
      p_val_adj < 0.05 & avg_log2FC < -0.25 ~ "Up in e12",
      TRUE ~ "Not significant"
    )
  )

ggplot(mesenchyme_de, aes(x = avg_log2FC, y = neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.6, size = 1) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed", color = "grey50") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey50") +
  labs(
    title = "Mesenchyme e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  theme_classic()

top_genes_mesenchyme <- mesenchyme_de %>%
  filter(p_val_adj < 0.01, abs(avg_log2FC) > 0.5)

volcano_mesenchyme_de <- ggplot(mesenchyme_de,
       aes(avg_log2FC, neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.5, size = 1) +
  ggrepel::geom_text_repel(
    data = top_genes_mesenchyme,
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey80"
  )) +
    labs(
    title = "Mesenchyme e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_classic()
ggsave(volcano_mesenchyme_de,
        filename = file.path(out_dir, "07-mesenchyme_control_de.png"),
        width = 28,
        height = 46)
```

## Myocardium

```{r}
control.myocardium.de <- FindMarkers(re_embed_interesting_cells,
                             ident.1 = "Myocardium_e11_control",
                             ident.2 = "Myocardium_e12_control",
                             verbose = FALSE)

arrange(control.myocardium.de, desc(abs(avg_log2FC))) %>% as_tibble(rownames = "gene")

myocardium_de <- control.myocardium.de %>%
  rownames_to_column("gene") %>%
  mutate(
    neg_log10_padj = -log10(p_val_adj),
    sig = case_when(
      p_val_adj < 0.05 & avg_log2FC >  0.25 ~ "Up in e11",
      p_val_adj < 0.05 & avg_log2FC < -0.25 ~ "Up in e12",
      TRUE ~ "Not significant"
    )
  )

ggplot(myocardium_de, aes(x = avg_log2FC, y = neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.6, size = 1) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed", color = "grey50") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey50") +
  labs(
    title = "Myocardium e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  theme_classic()

top_genes_myocardium <- myocardium_de %>%
  filter(p_val_adj < 0.01, abs(avg_log2FC) > 0.5)

volcano_myocardium_de <- ggplot(myocardium_de, aes(avg_log2FC, neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.5, size = 1) +
  ggrepel::geom_text_repel(
    data = top_genes_myocardium,
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey80"
  )) +
    labs(
    title = "Myocardium e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_classic()
ggsave(volcano_myocardium_de,
        filename = file.path(out_dir, "07-myocardium_control_de.png"),
        width = 28,
        height = 46)
```

## Endocardium

```{r}
control.endocardium.de <- FindMarkers(re_embed_interesting_cells,
                             ident.1 = "Endocardium_e11_control",
                             ident.2 = "Endocardium_e12_control",
                             verbose = FALSE)

arrange(control.endocardium.de, desc(abs(avg_log2FC))) %>% as_tibble(rownames = "gene")

endocardium_de <- control.endocardium.de %>%
  rownames_to_column("gene") %>%
  mutate(
    neg_log10_padj = -log10(p_val_adj),
    sig = case_when(
      p_val_adj < 0.05 & avg_log2FC >  0.25 ~ "Up in e11",
      p_val_adj < 0.05 & avg_log2FC < -0.25 ~ "Up in e12",
      TRUE ~ "Not significant"
    )
  )

ggplot(endocardium_de, aes(x = avg_log2FC, y = neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.6, size = 1) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed", color = "grey50") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey50") +
  labs(
    title = "Endocardium e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  theme_classic()

top_genes_endocardium <- endocardium_de %>%
  filter(p_val_adj < 0.01, abs(avg_log2FC) > 0.5)

ggplot(endocardium_de, aes(avg_log2FC, neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.5, size = 1) +
  ggrepel::geom_text_repel(
    data = top_genes_endocardium,
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey80"
  )) +
    labs(
    title = "Endocardium e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_classic()
```

## Epicardium

```{r}
control.epicardium.de <- FindMarkers(re_embed_interesting_cells,
                             ident.1 = "Epicardium_e11_control",
                             ident.2 = "Epicardium_e12_control",
                             verbose = FALSE)

arrange(control.epicardium.de, desc(abs(avg_log2FC))) %>% as_tibble(rownames = "gene")

epicardium_de <- control.epicardium.de %>%
  rownames_to_column("gene") %>%
  mutate(
    neg_log10_padj = -log10(p_val_adj),
    sig = case_when(
      p_val_adj < 0.05 & avg_log2FC >  0.25 ~ "Up in e11",
      p_val_adj < 0.05 & avg_log2FC < -0.25 ~ "Up in e12",
      TRUE ~ "Not significant"
    )
  )

ggplot(epicardium_de, aes(x = avg_log2FC, y = neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.6, size = 1) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed", color = "grey50") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey50") +
  labs(
    title = "Epicardium e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  theme_classic()

top_genes_epicardium <- epicardium_de %>%
  filter(p_val_adj < 0.01, abs(avg_log2FC) > 0.5)

ggplot(epicardium_de, aes(avg_log2FC, neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.5, size = 1) +
  ggrepel::geom_text_repel(
    data = top_genes_epicardium,
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey80"
  )) +
    labs(
    title = "Epicardium e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_classic()
```

## VSMC

```{r}
control.VSMC.de <- FindMarkers(re_embed_interesting_cells,
                             ident.1 = "VSMC_e11_control",
                             ident.2 = "VSMC_e12_control",
                             verbose = FALSE)

arrange(control.VSMC.de, desc(abs(avg_log2FC))) %>% as_tibble(rownames = "gene")

VSMC_de <- control.VSMC.de %>%
  rownames_to_column("gene") %>%
  mutate(
    neg_log10_padj = -log10(p_val_adj),
    sig = case_when(
      p_val_adj < 0.05 & avg_log2FC >  0.25 ~ "Up in e11",
      p_val_adj < 0.05 & avg_log2FC < -0.25 ~ "Up in e12",
      TRUE ~ "Not significant"
    )
  )

ggplot(VSMC_de, aes(x = avg_log2FC, y = neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.6, size = 1) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed", color = "grey50") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey50") +
  labs(
    title = "VSMC e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  theme_classic()

top_genes_VSMC <- VSMC_de %>%
  filter(p_val_adj < 0.01, abs(avg_log2FC) > 0.5)

ggplot(VSMC_de, aes(avg_log2FC, neg_log10_padj)) +
  geom_point(aes(color = sig), alpha = 0.5, size = 1) +
  ggrepel::geom_text_repel(
    data = top_genes_VSMC,
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  scale_color_manual(values = c(
    "Up in e11" = "firebrick",
    "Up in e12" = "steelblue",
    "Not significant" = "grey80"
  )) +
    labs(
    title = "VSMC e11 vs e12 (control)",
    x = "Average log2 fold change (e11 / e12)",
    y = "-log10 adjusted p-value",
    color = NULL
  ) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_classic()

```

