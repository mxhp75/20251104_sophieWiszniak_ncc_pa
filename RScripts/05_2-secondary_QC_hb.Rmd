---
title: "05-secondary_QC_hb"
author: "Melanie Smith"
date: "2025-12-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Clean-up environment

```{r}
rm(list = ls(all.names = TRUE)) # will clear all objects includuing hidden objects
gc() # free up memory and report the memory usage
options(max.print = .Machine$integer.max,
        scipen = 999,
        stringsAsFactors = FALSE,
        dplyr.summarise.inform = FALSE) # Print everything without truncation, avoid scientific notation, keep strings as characters, silence dplyr’s “grouped output” informational messages
set.seed(42) # set seed for reproducibility
```

# Load Libraries

```{r}
# Core tidyverse
library(tidyverse)
library(tibble)
library(dplyr)
library(tidyr)

# Single Cell
library(Seurat) # Seurat (relies on dplyr/tidyr, so load after tidyverse)

library(SingleCellExperiment)
library(biomaRt)
library(scuttle)

# additional plotting functions
library(patchwork)
library(pheatmap)
```

# User defined functions

```{r}
# quick function (following from Nick's) to plot the QC metrics
my_plot_function <- function(object, grouping_variable, variables_to_plot) {
  
  group_var_sym <- sym(grouping_variable)
  
  object[[]] %>%
    as_tibble(rownames = "barcode") %>%
    dplyr::select(barcode, !!group_var_sym, all_of(variables_to_plot)) %>%
    pivot_longer(
      cols = -c(barcode, !!group_var_sym),
      names_to = "metric",
      values_to = "values"
    ) %>%
    ggplot(aes(x = !!group_var_sym, y = values)) +
    
    # Right half: density + median line
    ggdist::stat_halfeye(
      side = "right",
      fill = "dodgerblue",
      alpha = 0.5,
      .width = 0.5,           # median line
      justification = -0.2,
      scale = 0.9,
      linewidth = 0.4,
      color = "black"
    ) +
    
    # Left half: dots
    ggdist::stat_dots(
      side = "left",
      alpha = 0.3,
      justification = 1.25,
      quantiles = NULL,       # prevents binwidth error
      dotsize = 0.7
    ) +
    
    facet_wrap(~ metric, scales = "free") +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major.x = element_blank()
    )
}
```

# Set project directories and file paths

```{r}
project_name <- "20251104_sophieWiszniak_ncc_pa"

base_repo_dir <- "/home/melanie-smith/workDir/sophieWiszniak"
project_repo_dir <- file.path(base_repo_dir, project_name)
data_base_dir <- file.path(project_repo_dir, "rawData")
out_dir <- file.path(project_repo_dir, "outDir")
downloads <- file.path(project_repo_dir, "downloads")

```

# Load required objects
- This object has been filtered for doublets and >10% MT genes

```{r}
re_embed_no_rbc <- readRDS(file = file.path(out_dir, "04-filtering", "re_embed_no_rbc.rds"))
```

- This object has been filtered for doublets and >10% MT genes and hb >0.22%

```{r}
re_embed_no_rbc_no_hb <- readRDS(file = file.path(out_dir, "05-secondary_QC", "re_embed_no_rbc_no_hb.rds"))

# Ensure sophie's annotation is the default identity from here
re_embed_no_rbc_no_hb <- SetIdent(re_embed_no_rbc_no_hb,
                            value = "sophie_celltype_clean")
```

## Plot cell-type marker genes
nb: The marker genes used here are from (Single-cell RNA-Seq of the developing cardiac outflow tract reveals convergent development of the vascular smooth muscle cells)[https://www.sciencedirect.com/science/article/pii/S2211124719308721?via%3Dihub#fig5]

- Macrophage

```{r}
macrophage_markers <- FeaturePlot(
  object = re_embed_no_rbc,
  features = c("Fcgr1", "Adgre1"),
  ncol = 2,                      # side-by-side panels
  order = TRUE                   # high-expression cells on top
  ) &
  scale_colour_gradientn(
    colours = rev(RColorBrewer::brewer.pal(11, "Spectral")),
    name = "Expression"
  ) &
  plot_annotation(
    title = "Macrophage markers",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "E11–E12 mouse heart"
  ) &
  theme_bw(base_size = 14) &
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
ggsave(macrophage_markers, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_macrophage_genes.png"),
       width = 16,
       height = 8)
```

- Epicardial lineage

```{r}
epicardial_markers <- FeaturePlot(
  object = re_embed_no_rbc,
  features = c("Upk3b", "Upk1b"),
  ncol = 2,                      # side-by-side panels
  order = TRUE                   # high-expression cells on top
  ) &
  scale_colour_gradientn(
    colours = rev(RColorBrewer::brewer.pal(11, "Spectral")),
    name = "Expression"
  ) &
  plot_annotation(
    title = "Epicardial lineage markers",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "E11–E12 mouse heart"
  ) &
  theme_bw(base_size = 14) &
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
ggsave(epicardial_markers, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_epicardial_genes.png"),
       width = 16,
       height = 8)
```

- Mesenchymal lineage

```{r}
mesenchymal_markers <- FeaturePlot(
  object = re_embed_no_rbc,
  features = c("Postn", "Cthrc1"),
  ncol = 2,                      # side-by-side panels
  order = TRUE                   # high-expression cells on top
  ) &
  scale_colour_gradientn(
    colours = rev(RColorBrewer::brewer.pal(11, "Spectral")),
    name = "Expression"
  ) &
  plot_annotation(
    title = "Mesenchymal lineage markers",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "E11–E12 mouse heart"
  ) &
  theme_bw(base_size = 14) &
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
ggsave(mesenchymal_markers, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_mesenchymal_genes.png"),
       width = 16,
       height = 8)
```

- Myochardial lineage

```{r}
myocardial_markers <- FeaturePlot(
  object = re_embed_no_rbc,
  features = c("Myh7", "Myl4"),
  ncol = 2,                      # side-by-side panels
  order = TRUE                   # high-expression cells on top
  ) &
  scale_colour_gradientn(
    colours = rev(RColorBrewer::brewer.pal(11, "Spectral")),
    name = "Expression"
  ) &
  plot_annotation(
    title = "Myocardial lineage markers",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "E11–E12 mouse heart"
  ) &
  theme_bw(base_size = 14) &
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
ggsave(myocardial_markers, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_myocardial_genes.png"),
       width = 16,
       height = 8)
```

- Endocardial lineage

```{r}
endocardial_markers <- FeaturePlot(
  object = re_embed_no_rbc,
  features = c("Ecscr", "Cdh5"),
  ncol = 2,                      # side-by-side panels
  order = TRUE                   # high-expression cells on top
  ) &
  scale_colour_gradientn(
    colours = rev(RColorBrewer::brewer.pal(11, "Spectral")),
    name = "Expression"
  ) &
  plot_annotation(
    title = "Endocardial lineage markers",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "E11–E12 mouse heart"
  ) &
  theme_bw(base_size = 14) &
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
ggsave(endocardial_markers, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_endocardial_genes.png"),
       width = 16,
       height = 8)
```

- VSMC lineage

```{r}
vsmc_markers <- FeaturePlot(
  object = re_embed_no_rbc,
  features = c("Cxcl12", "Rgs5"),
  ncol = 2,                      # side-by-side panels
  order = TRUE                   # high-expression cells on top
  ) &
  scale_colour_gradientn(
    colours = rev(RColorBrewer::brewer.pal(11, "Spectral")),
    name = "Expression"
  ) &
  plot_annotation(
    title = "VSMC lineage markers",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "E11–E12 mouse heart"
  ) &
  theme_bw(base_size = 14) &
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )
ggsave(vsmc_markers, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_vsmc_genes.png"),
       width = 16,
       height = 8)
```

## Dot plots of lineage markers

```{r}
# lets start with a list of broad lineage marker genes
macrophage_genes <- c("Coro1a", "C3ar1", "Rac2", "C1qb", "Tyrpbp")

epicardial_genes <- c("Wt1", "Upk3b", "Apela", "Upk1b", "Aldh1a2")
ep_c10 <- c("Myl7", "Tmem255a")
ep_c11 <- c("Eln", "Dlk1", "Klk14")

endocardial_genes <- c("Ecscr", "Cdh5", "Tie1", "Rasip1", "Plxnd1")
ed_c5 <- c("Crip1", "Hapln1", "Igfbp7")
ed_c6 <- c("Rbp1", "Crip1", "Fbln5", "Gja4")
ed_c12 <- c("Emcn", "klhl4", "Gatm", "Akap12")

myocardial_genes <- c("Chchd10", "Sh3bgr", "Ttn", "Pln", "Myh7")
mc_c2 <- c("Myl2", "Atp1b1", "Cox6a2")
mc_c9 <- c("Bmp4", "Malat1", "Gpc3")

mesenchymal_genes <- c("Postn", "Vcan", "Dbi", "Cthrc1", "Papss2")
ms_c0 <- c("Itga4", "Pla2g16", "Myl2")
ms_c1 <- c("Htra1", "Eln")
ms_c7 <- c("Actb", "Cbx3", "Kdelr2", "Slc39a1")
ms_c8 <- c("Penk", "Cxcl12", "Fbln5", "Wnt5a")

vsmc_genes <- c("Cxcl12", "Iigp1", "Eln", "Fbln5", "Rgs5")
vsmc_c3 <- c("Sfrp2", "Osr1", "Bgn", "Cd34")
vsmc_c6 <- c("Rbp1", "Fbln5", "Gja4")
vsmc_c12 <- c("Emcn", "Klhl4", "Gatm", "Akap12")
```

## Macrophage dotplot

```{r}
# Generate DotPlot for original_clusters_mt_dbl markers
Idents(re_embed_no_rbc) <- "original_clusters_mt_dbl"
dotPlot_original_clusters_macrophage <- DotPlot(re_embed_no_rbc,
        features = macrophage_genes,
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Macrophage Genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_original_clusters_macrophage,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters_macrophage.png"),
       width = 16,
       height = 6)
```

## Epicardial dotplot

```{r}
dotPlot_original_clusters_epicardial <- DotPlot(re_embed_no_rbc,
        features = epicardial_genes,
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Epicardial lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_original_clusters_epicardial,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters_epicardial.png"),
       width = 16,
       height = 6)

# all the epicardial genes
epicardial_plus <- c(epicardial_genes, ep_c10, ep_c11)
dotPlot_epicardial_plus <- DotPlot(re_embed_no_rbc,
        features = epicardial_plus,
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Epicardial (plus) lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_epicardial_plus,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_epicardial_plus.png"),
       width = 16,
       height = 6)
```

## Endocardial dotplot

```{r}
dotPlot_original_clusters_endocardial <- DotPlot(re_embed_no_rbc,
        features = endocardial_genes,
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Endocardial lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_original_clusters_endocardial,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters_endocardial.png"),
       width = 16,
       height = 6)

# all the endocardial genes
endocardial_plus <- c(endocardial_genes, ed_c5, ed_c6, ed_c12)
dotPlot_endocardial_plus <- DotPlot(re_embed_no_rbc,
        features = unique(endocardial_plus),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Endocardial (plus) lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_endocardial_plus,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_endocardial_plus.png"),
       width = 16,
       height = 6)
```

## Myocardial dotplots

```{r}
dotPlot_original_clusters_myocardial <- DotPlot(re_embed_no_rbc,
        features = myocardial_genes,
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Myocardial lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_original_clusters_myocardial,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters_myocardial.png"),
       width = 16,
       height = 6)

# all the myocardial genes
myocardial_plus <- c(myocardial_genes, mc_c2, mc_c9)
dotPlot_myocardial_plus <- DotPlot(re_embed_no_rbc,
        features = unique(myocardial_plus),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Myocardial (plus) lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_myocardial_plus,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_myocardial_plus.png"),
       width = 16,
       height = 7)
```

## Mesenchymal dotplots

```{r}
dotPlot_original_clusters_mesenchymal <- DotPlot(re_embed_no_rbc,
        features = mesenchymal_genes,
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Mesenchymal lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_original_clusters_mesenchymal,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters_mesenchymal.png"),
       width = 16,
       height = 6)

# all the mesenchymal genes
mesenchymal_plus <- c(mesenchymal_genes, ms_c0, ms_c1, ms_c7, ms_c8)
dotPlot_mesenchymal_plus <- DotPlot(re_embed_no_rbc,
        features = unique(mesenchymal_plus),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Mesenchymal (plus) lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_mesenchymal_plus,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_mesenchymal_plus.png"),
       width = 16,
       height = 7)
```

## VSMC dotplots

```{r}
dotPlot_original_clusters_vsmc <- DotPlot(re_embed_no_rbc,
        features = vsmc_genes,
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "VSMC lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_original_clusters_vsmc,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters_vsmc.png"),
       width = 16,
       height = 6)

# all the VSMC genes
vsmc_plus <- c(vsmc_genes, vsmc_c3, vsmc_c6, vsmc_c12)
dotPlot_vsmc_plus <- DotPlot(re_embed_no_rbc,
        features = unique(vsmc_plus),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "VSMC (plus) lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_vsmc_plus,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_vsmc_plus.png"),
       width = 16,
       height = 7)

```

```{r}
dotPlot_markers <- DotPlot(re_embed_no_rbc,
        features = c(mesenchymal_genes,
                     vsmc_genes,
                     epicardial_genes,
                     endocardial_genes,
                     macrophage_genes,
                     myocardial_genes
                     ),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "All lineage Genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC removed",
    caption = "Mib1 KO vs control"
    )
print(dotPlot_markers)   
ggsave(dotPlot_markers,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_markers.png"),
       width = 16,
       height = 8)

# all the marker genes
all_markers <- c(mesenchymal_plus,
                 vsmc_plus,
                 epicardial_plus,
                 endocardial_plus,
                 macrophage_genes,
                 myocardial_plus
                 )
dotPlot_all_markers <- DotPlot(re_embed_no_rbc,
        features = unique(all_markers),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Combined cell-type marker genes",
    subtitle = "Filtered: <10% MT, singlets only, RBC removed",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_all_markers,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_all_markers.png"),
       width = 20,
       height = 12)

```

# Slight detour to take a look at the star cluster markers

```{r}
# Cells with your "poor quality" pattern
poor_cells <- rownames(re_embed_no_rbc_no_hb@meta.data)[
  re_embed_no_rbc_no_hb$nCount_RNA < 3500 &    # adjust to your "low" threshold
    re_embed_no_rbc_no_hb$nFeature_RNA < 2000 &
    re_embed_no_rbc_no_hb$percent.mt < 5 &       # "relatively low"
    re_embed_no_rbc_no_hb$percent.hb > 0.1      # "relatively high"
]

# Quick stats
cat("Number of 'poor quality' cells:", length(poor_cells), "\n")

# Top genes in these cells (should be Hb-heavy if erythrocytes)
top_genes <- FindMarkers(re_embed_no_rbc_no_hb, ident.1 = poor_cells, only.pos = TRUE, min.pct = 0.25)
head(top_genes, 10)   # Expect Hba-a1, Hbb-bs, etc.

# Check proliferation markers
VlnPlot(re_embed_no_rbc_no_hb, features = c("Mki67", "Pcna", "Top2a"), group.by = "original_clusters_mt_dbl")
# If high in your poor clusters → proliferating erythrocytes

# Check in UMAP
DimPlot(re_embed_no_rbc_no_hb,
        cells.highlight = poor_cells,
        cols.highlight = "red") +
  ggtitle("Poor quality cells in UMAP")

# Extract the cell barcodes that are "filtered"
filtered_cells_sophieFiltered <- WhichCells(re_embed_no_rbc_no_hb, 
                             expression = sophie_celltype_clean == "filtered")

# Now plot — highlighted in red, everything else gray
DimPlot(re_embed_no_rbc_no_hb,
        cells.highlight = filtered_cells_sophieFiltered,
        cols.highlight = "red",      # colour for filtered cells
        cols = "gray80",             # colour for all other cells
        pt.size = 0.8,
        order = TRUE) +              # puts highlighted cells on top
  ggtitle("Filtered cells highlighted on UMAP") +
  theme(legend.position = "none")

# Extract the cell barcodes that are have percent.hb >0.1%
filtered_cells_hb <- WhichCells(re_embed_no_rbc_no_hb, 
                             expression = percent.hb > 0.1)

# Now plot — highlighted in red, everything else gray
DimPlot(re_embed_no_rbc_no_hb,
        cells.highlight = filtered_cells_hb,
        cols.highlight = "red",      # colour for filtered cells
        cols = "gray80",             # colour for all other cells
        pt.size = 0.8,
        order = TRUE) +              # puts highlighted cells on top
  ggtitle(">0.1% hb cells highlighted on UMAP") +
  theme(legend.position = "none")

# Let's take a look at the genes chatGPT suggested are indicative of soup/ambient
ambient_identity_genes <- c(
  "Alas2", "Klf1", "Gata1", "Epor",
  "Gypa", "Actb", "Gapdh", "Tubb5"
  )
erythroid_identity_genes <- c(
  "Gata1", "Klf1", "Epor", "Gypa",
  "Alas2", "Tal1", "Lmo2", "Nfe2"
  )

soupPlot <- FeaturePlot(
  object = re_embed_no_rbc_no_hb,
  features = c(
    ambient_identity_genes
  )
  ) &
  scale_colour_gradientn(
    colours = rev(
      RColorBrewer::brewer.pal(
        n = 11,
        name = "Spectral"
      )
    )
  ) &
  plot_annotation(
    title = "Expression of genes (ambient vs erythroid) — is it soup?",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%",
    caption = "Mib1 KO vs control"
  )
ggsave(soupPlot, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_no_hb_ambient_genes.png"),
       width = 8,
       height = 8)

erythroidPlot <- FeaturePlot(
  object = re_embed_no_rbc_no_hb,
  features = c(
    erythroid_identity_genes
  )
  ) &
  scale_colour_gradientn(
    colours = rev(
      RColorBrewer::brewer.pal(
        n = 11,
        name = "Spectral"
      )
    )
  ) &
  plot_annotation(
    title = "Expression of genes (ambient vs erythroid) — is it soup?",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%",
    caption = "Mib1 KO vs control"
  )
ggsave(erythroidPlot,
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_no_hb_erythroid_genes.png"),
       width = 8,
       height = 8)
```


# Automatic thresholding via MAD (median absolute deviations)

```{r}
# Enter the number of deviations required
n_mad <- 3    # number of MADs for nCount and nFeature deviation

# Lower bound for nCounts
nCounts_lower <- median(log10(re_embed_no_rbc_no_hb@meta.data$nCount_RNA)) - 
  (mad(log10(re_embed_no_rbc_no_hb@meta.data$nCount_RNA)) * n_mad)

# Lower bound for nFeatures -> remove everything BELOW this number
nFeatures_lower <- median(log10(re_embed_no_rbc_no_hb@meta.data$nFeature_RNA)) - 
  (mad(log10(re_embed_no_rbc_no_hb@meta.data$nFeature_RNA)) * n_mad)

# Calculate the percentage of counts in the top 20 features
counts <- GetAssayData(re_embed_no_rbc_no_hb, layer = "counts")
top20_per_cell <- apply(counts, 2, function(x) {
  if(sum(x) == 0) return(0)
  sum(sort(x, decreasing = TRUE)[1:20])
})

# Add to the seurat object
re_embed_no_rbc_no_hb$pct_counts_in_top_20_features <- 100 * top20_per_cell / colSums(counts)

# Clean up large object
rm(counts, top20_per_cell)
gc()

# Upper bound for percentage top 20 transcripts (lenient 5 mads)
percent_top20_upper <- median(re_embed_no_rbc_no_hb@meta.data$pct_counts_in_top_20_features) + 
  (mad(re_embed_no_rbc_no_hb@meta.data$pct_counts_in_top_20_features) * 5)

# Calculate the feature count distance (identifies cells where the "expected" relationship between nCounts and nFeatures is violated)
re_embed_no_rbc_no_hb$featcount_dist <- {
  abs(resid(lm(log10(nFeature_RNA + 1) ~ log10(nCount_RNA + 1), 
               data = re_embed_no_rbc_no_hb@meta.data)))
}

# Upper bound for feature-count distance (lenient 5 mads)
featCount_dist_upper <- median(re_embed_no_rbc_no_hb@meta.data$featcount_dist) + 
  (mad(re_embed_no_rbc_no_hb@meta.data$featcount_dist) * 5)

```

# Secondary QC plots

```{r}
# Specify which metrics we want to look at
qc_metrics <- c("nCount_RNA", "nFeature_RNA", "percent.hb", "pct_counts_in_top_20_features", "featcount_dist")

# make the plots
secondary_qc_plot <- my_plot_function(
  object = re_embed_no_rbc_no_hb,
  grouping_variable = "seurat_clusters",
  variables_to_plot = qc_metrics
)

# add threshold lines to the QC plot
hline_data_1 <- tibble(
  metric = c("nCount_RNA", "nFeature_RNA", "pct_counts_in_top_20_features", "featcount_dist"),
  threshold = c(10^nCounts_lower, 10^nFeatures_lower, percent_top20_upper, featCount_dist_upper)   # thresholds for each
)

# set an upper bound??
# hline_data_2 <- tibble(
#   metric = c("nCount_RNA", "nFeature_RNA", "percent.hb"),
#   threshold             = c(50000, 7500, 20)   # thresholds for each
# )

# add the hlines
secondary_qc_plot +
  geom_hline(data = hline_data_1,
             aes(yintercept = threshold),
             colour = "red",
             linewidth = 1,
             linetype = "dashed") +
  geom_hline(data = hline_data_2,
             aes(yintercept = threshold),
             colour = "red",
             linewidth = 1,
             linetype = "dashed")

# plot the nCount x nFeature scatter coloured by %hb
re_embed_no_rbc_no_hb@meta.data %>%
  ggplot(aes(x = log10(nCount_RNA),
             y = log10(nFeature_RNA),
             colour = percent.hb)) +
  geom_point() +
  scale_colour_gradient(low = "lightcoral",   # light red for low %
                        high = "darkred",     # dark red for high %
                        na.value = "grey80") +  # gray for any missing values
  theme_bw() +
  labs(colour = "% Hb",                      # nicer legend label
       x = expression(log[10]~nCount_RNA),                     # optional: clean axis labels
       y = expression(log[10]~nFeature_RNA)) +
  theme(legend.position = "right")           # optional: legend placement
ggsave(filename = file.path(out_dir, "05-secondary_QC/scatter_re_embed_noRBA_noHB.png"),
       width = 8, height = 8)


## log10 scale the nCount and nFeatures for better visualisation
re_embed_no_rbc_no_hb$log10_nCount_RNA <- log10(re_embed_no_rbc_no_hb$nCount_RNA + 1)

my_plot_function(
  object = re_embed_no_rbc_no_hb,
  grouping_variable = "seurat_clusters",
  variables_to_plot = "log10_nCount_RNA") +
  geom_hline(yintercept = nCounts_lower,
             colour = "red",
             linetype = "dashed",
             linewidth = 1.5)

re_embed_no_rbc_no_hb$log10_nFeatures_RNA <- log10(re_embed_no_rbc_no_hb$nFeature_RNA + 1)
my_plot_function(
  object = re_embed_no_rbc_no_hb,
  grouping_variable = "seurat_clusters",
  variables_to_plot = "log10_nFeatures_RNA") +
  geom_hline(yintercept = nFeatures_lower,
             colour = "red",
             linetype = "dashed",
             linewidth = 1.5)
```

## Define final thresholds

```{r}
qc_thresholds <- list(
  nCount_RNA_lower      = 10^nCounts_lower,
  nFeature_RNA_lower    = 10^nFeatures_lower,
  pct_top20_upper       = percent_top20_upper,
  featcount_dist_upper  = featCount_dist_upper
)

# Print thresholds for documentation
cat("=== QC Thresholds Applied ===\n")
cat("nCount_RNA_lower:     ", round(qc_thresholds$nCount_RNA_lower, 2), "\n")
cat("nFeature_RNA_lower:   ", round(qc_thresholds$nFeature_RNA_lower, 2), "\n")
cat("pct_top20_upper:      ", round(qc_thresholds$pct_top20_upper, 2), "%\n")
cat("featcount_dist_upper: ", round(qc_thresholds$featcount_dist_upper, 4), "\n\n")
```

# Apply QC filters with rescue logic

```{r}
meta_qc <- re_embed_no_rbc_no_hb@meta.data %>%
  mutate(
    # Standard QC metrics — TRUE = pass
    pass_nCount      = nCount_RNA >= qc_thresholds$nCount_RNA_lower,
    pass_nFeature    = nFeature_RNA >= qc_thresholds$nFeature_RNA_lower,
    pass_top20       = pct_counts_in_top_20_features <= qc_thresholds$pct_top20_upper,
    pass_dist        = featcount_dist <= qc_thresholds$featcount_dist_upper,

    # Overall passing cell (strict)
    pass_all = pass_nCount & 
      pass_nFeature & 
      pass_percent_hb & 
      pass_top20 & 
      pass_dist & 
      pass_RBC_cluster,
    
    # Count how many of the 5 technical metrics fail
    n_technical_fails = (!pass_nCount) + (!pass_nFeature) + 
      (!pass_top20) + (!pass_dist),
    
    # Rescue cells that fail ≤1 technical metric AND pass RBC filter
    # Change to == 1 if you only want to rescue cells with exactly 1 failure
    pass_rescue = n_technical_fails <= 1
    )

```

# Summary statistics

```{r}
cat("=== QC Summary ===\n")
cat("Total cells before QC:                        ", nrow(meta_qc), "\n")
cat("Cells passing strict rules (pass_all):        ", sum(meta_qc$pass_all), "\n")
cat("Cells with 0 technical failures:              ", sum(meta_qc$n_technical_fails == 0), "\n")
cat("Cells with exactly 1 technical failure:       ", sum(meta_qc$n_technical_fails == 1), "\n")
cat("Final cells kept (pass_rescue):               ", sum(meta_qc$pass_rescue), "\n")
cat("Low-quality cells removed (≥2 fails):         ", sum(!meta_qc$pass_rescue), "\n")
cat("  - Removed due to ≥2 technical failures:     ", sum(meta_qc$n_technical_fails >= 2), "\n\n")

# Breakdown by number of technical failures
cat("=== Distribution of Technical Failures ===\n")
print(table(n_technical_fails = meta_qc$n_technical_fails))
cat("\n")

# Add back to Seurat object
re_embed_no_rbc_no_hb@meta.data <- meta_qc
```

# Visualisation: QC heatamp

```{r}
qc_matrix <- meta_qc %>%
  arrange(seurat_clusters) %>%
  dplyr::select(pass_nCount, pass_nFeature,
                pass_top20, pass_dist, pass_rescue) %>%
  dplyr::mutate(across(everything(), as.numeric)) %>%
  as.matrix()

# Add row annotation
annotation_row <- data.frame(Cluster = meta_qc$seurat_clusters[order(meta_qc$seurat_clusters)])
rownames(annotation_row) <- rownames(qc_matrix)
# Set Colour palette — ONLY for the clusters that actually exist
ann_colors <- list(
  Cluster = setNames(rainbow(length(unique(meta_qc$seurat_clusters))),
                     sort(unique(meta_qc$seurat_clusters)))
)

pheatmap::pheatmap(qc_matrix,
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   annotation_row = annotation_row,
                   annotation_colors = ann_colors,
                   color = c("red", "darkgreen"),
                   legend_breaks = 0:1,
                   legend_labels = c("FAIL", "PASS"),
                   show_rownames = FALSE,
                   main = "QC Metrics per Cell (ordered by cluster)")
```

# Remove cells that fail 2 or more secondary QC metrics and re-embed

```{r}

# Subset to remove cells that fail pass_rescue (aka have 2 or more technical fails)
re_embed_no_rbc_no_hb_yes_qc <- subset(re_embed_no_rbc_no_hb, 
                                subset = pass_rescue == TRUE)
cat("Cells before technical filtering:", ncol(re_embed_no_rbc_no_hb), "\n")
cat("Cells that failed technical filter:", sum(!re_embed_no_rbc_no_hb$pass_percent_hb), "\n")
cat("Cells after technical filtering:", ncol(re_embed_no_rbc_no_hb_yes_qc), "\n")
```

# Re-embed: Normalise, find variable features, scale, PCA, UMAP, cluster

```{r}
n_dims = 30
clustering_resolution = 0.8
# Re-computation of graph-based clustering and UMAP on the cleaned dataset
re_embed_no_rbc_no_hb_yes_qc <- FindVariableFeatures(re_embed_no_rbc_no_hb_yes_qc,
                                        selection.method = "vst", 
                                        nfeatures = 3000,
                                        verbose = FALSE) %>%
  ScaleData(features = rownames(re_embed_no_rbc_no_hb_yes_qc),
            verbose = FALSE) %>%
  RunPCA(verbose = FALSE) %>% # Defaults to features = VariableFeatures()), but better not to specify as these are not yet stored in that object
  FindNeighbors(dims = 1:n_dims,
                verbose = FALSE) %>%
  FindClusters(resolution = clustering_resolution,
               verbose = FALSE) %>%
  RunUMAP(dims = 1:n_dims,
          verbose = FALSE)

# let's save here and reload in a new session
# write_rds(x = re_embed_no_rbc_no_hb_yes_qc,
#           file = file.path(out_dir, "05-secondary_QC", "re_embed_no_rbc_no_hb_yes_qc.rds"))

```

# Visualize the new embedding

```{r}

DimPlot(re_embed_no_rbc_no_hb_yes_qc,
        reduction = "umap",
        group.by = "original_clusters_mt_dbl",
        
        label = TRUE,
        label.size = 5
        ) +
  labs(
    title = "Filtered: <10% MT, singlets only, no RBC, no hb>0.22%, QC old clusters",
    subtitle = "E11–E12 mouse heart",
    caption = "Mib1 KO vs control"
  )
ggsave(filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_no_hb_qc_old_clusters.png"),
       width = 12,
       height = 8)

# UMAP by new clusters
p1 <- DimPlot(re_embed_no_rbc_no_hb_yes_qc, 
              reduction = "umap",
              group.by = "seurat_clusters",
              label = TRUE,
              label.size = 4) +
  ggtitle("New Clusters (after secondary QC)")

# UMAP by Sophie's cell type annotations
p2 <- DimPlot(re_embed_no_rbc_no_hb_yes_qc, 
              reduction = "umap",
              group.by = "sophie_celltype_clean",
              label = TRUE,
              label.size = 3,
              repel = TRUE) +
  ggtitle("Sophie's Cell Type Annotations (after secondary QC)")

# Display plots
p1 + p2
ggsave(p1, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_cluster_no_RBC_no_hb_yes_qc.png"),
       width = 8,
       height = 8)
ggsave(p2, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_celltype_no_RBC_no_hb_yes_qc.png"),
       width = 8,
       height = 8)

# Check QC metrics in the new embedding
p3 <- FeaturePlot(re_embed_no_rbc_no_hb_yes_qc, 
                  features = c("nCount_RNA", "nFeature_RNA", 
                               "percent.mt", "percent.hb",
                               "featcount_dist", "pct_counts_in_top_20_features"),
                  ncol = 3)  &
  scale_colour_gradientn(
    colours = rev(
      RColorBrewer::brewer.pal(
        n = 11, 
        name = "Spectral")
      )
    )
print(p3)
ggsave(p3, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_QCmetrics_no_RBC_no_hb_yes_qc.png"),
       width = 12,
       height = 8)

DimPlot(re_embed_no_rbc_no_hb_yes_qc, 
              reduction = "umap",
              group.by = "SingleR_tms",
              label = TRUE,
              label.size = 3,
              repel = TRUE) +
  ggtitle("SingleR_tms Cell Type Annotations (after secondary QC)")

DimPlot(re_embed_no_rbc_no_hb_yes_qc, 
              reduction = "umap",
              group.by = "SingleR_HCA_main",
              label = TRUE,
              label.size = 3,
              repel = TRUE) +
  ggtitle("SingleR_HCA_main Cell Type Annotations (after secondary QC)")

DimPlot(re_embed_no_rbc_no_hb_yes_qc, 
              reduction = "umap",
              group.by = "SingleR_HCA_fine",
              label = TRUE,
              label.size = 3,
              repel = TRUE) +
  ggtitle("SingleR_HCA_fine Cell Type Annotations (after secondary QC)")

DimPlot(re_embed_no_rbc_no_hb_yes_qc, 
              reduction = "umap",
              group.by = "sophie_annotation",
              label = TRUE,
              label.size = 5,
              repel = TRUE) +
  ggtitle("sophie_annotation Cell Type Annotations (after secondary QC)")

```

# is it soup?

```{r}
# Let's take a look at the genes chatGPT suggested are indicative of soup/ambient
hb_identity_genes <- c(
  "Hba-a1", "Hba-a2",
  "Hbb-bs", "Hbb-bt", "Hba-x"
  )
ambient_identity_genes <- c(
  "Actb", "Gapdh", "Tubb5"
  )
erythroid_identity_genes <- c(
  "Gata1", "Klf1", "Epor", "Gypa",
  "Alas2", "Tal1", "Lmo2", "Nfe2",
  "Slc4a1"
  )
hb_soupPlot_qc <- FeaturePlot(
  object = re_embed_no_rbc_no_hb_yes_qc,
  features = c(
    hb_identity_genes
    )
  ) &
  scale_colour_gradientn(
    colours = rev(
      RColorBrewer::brewer.pal(
        n = 11,
        name = "Spectral"
      )
    )
  ) &
  plot_annotation(
    title = "Expression of genes (ambient vs erythroid) — Hb soup plot",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%, yes QC",
    caption = "Mib1 KO vs control"
  )
ggsave(hb_soupPlot_qc, 
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_no_hb_qc_hb_genes.png"),
       width = 8,
       height = 8)

erythroidPlot_qc <- FeaturePlot(
  object = re_embed_no_rbc_no_hb_yes_qc,
  features = c(
    erythroid_identity_genes
  )
  ) &
  scale_colour_gradientn(
    colours = rev(
      RColorBrewer::brewer.pal(
        n = 11,
        name = "Spectral"
      )
    )
  ) &
  plot_annotation(
    title = "Expression of genes (ambient vs erythroid) — erythroid genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%, yes QC",
    caption = "Mib1 KO vs control"
  )
ggsave(erythroidPlot_qc,
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_no_hb_qc_erythroid_genes.png"),
       width = 8,
       height = 8)

ambientPlot_qc <- FeaturePlot(
  object = re_embed_no_rbc_no_hb_yes_qc,
  features = c(
    ambient_identity_genes
    )
  ) &
  scale_colour_gradientn(
    colours = rev(
      RColorBrewer::brewer.pal(
        n = 11,
        name = "Spectral"
      )
    )
  ) &
  plot_annotation(
    title = "Expression of genes (ambient vs erythroid) — ambient genes",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%, yes QC",
    caption = "Mib1 KO vs control"
  )
ggsave(erythroidPlot_qc,
       filename = file.path(out_dir, "05-secondary_QC", "05-umap_re_embed_no_RBC_no_hb_qc_ambient_genes.png"),
       width = 8,
       height = 8)
```

# Find marker genes

```{r}

# Find top 10 marker genes for seurat_clusters
Idents(re_embed_no_rbc_no_hb_yes_qc) <- "seurat_clusters"
markers_seurat_clusters <- FindAllMarkers(re_embed_no_rbc_no_hb_yes_qc,
                                          test.use = "wilcox",
                                          min.pct = 0.25,
                                          logfc.threshold = 0.25,
                                          verbose = FALSE)

# Get top 10 per cluster (sorted by avg_log2FC)
top10_seurat_clusters <- markers_seurat_clusters %>%
  group_by(cluster) %>%
  slice_max(n = 10,
            order_by = avg_log2FC,
            with_ties = FALSE)

# Print or view
print(top10_seurat_clusters)
write_csv(top10_seurat_clusters,
          file = file.path(out_dir, "05-secondary_QC/top10_seurat_cluster_markers.csv"))
# Find top 10 marker genes for original_clusters_mt_dbl
Idents(re_embed_no_rbc_no_hb_yes_qc) <- "original_clusters_mt_dbl"
markers_original_clusters <- FindAllMarkers(re_embed_no_rbc_no_hb_yes_qc,
                                            test.use = "wilcox",
                                            min.pct = 0.25,
                                            logfc.threshold = 0.25,
                                            verbose = FALSE)

# Get top 10 per cluster
top10_original_clusters <- markers_original_clusters %>%
  group_by(cluster) %>%
  slice_max(n = 10, order_by = avg_log2FC, with_ties = FALSE)

# Print or view
print(top10_original_clusters)
write_csv(top10_original_clusters,
          file = file.path(out_dir, "05-secondary_QC/top10_original_cluster_markers.csv"))

# Generate DotPlot for seurat_clusters markers
Idents(re_embed_no_rbc_no_hb_yes_qc) <- "seurat_clusters"
dotPlot_seurat_clusters <- DotPlot(re_embed_no_rbc_no_hb_yes_qc,
        features = unique(top10_seurat_clusters$gene),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5)) +
  labs(
    title = "Top 10 Marker Genes - Seurat Clusters",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%, yes QC",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_seurat_clusters,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_seurat_clusters.png"),
       width = 32,
       height = 8)

# Generate DotPlot for original_clusters_mt_dbl markers
Idents(re_embed_no_rbc_no_hb_yes_qc) <- "original_clusters_mt_dbl"
dotPlot_original_clusters <- DotPlot(re_embed_no_rbc_no_hb_yes_qc,
        features = unique(top10_original_clusters$gene),
        dot.scale = 6,
        cols = c("blue", "red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Top 10 Marker Genes - Original Clusters",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%, yes QC",
    caption = "Mib1 KO vs control"
    )
   
ggsave(dotPlot_original_clusters,
       filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters.png"),
       width = 32,
       height = 8)
```

## Plot a subset of clusters
### Original clusters
```{r}
# Choose the clusters you want to plot
clusters_to_plot <- c(2, 8, 13, 18, 22, 23, 26, 28)

# Temporary subset — keep only cells from those clusters
subset_obj <- subset(re_embed_no_rbc_no_hb_yes_qc,
                     subset = original_clusters_mt_dbl %in% clusters_to_plot)

# Set identity
Idents(subset_obj) <- "original_clusters_mt_dbl"

# Filter top10_original_clusters to keep only genes that are markers for the selected clusters
relevant_genes <- top10_original_clusters %>%
  filter(cluster %in% clusters_to_plot) %>%
  pull(gene) %>%
  unique()

# Now make the DotPlot — only relevant genes
DotPlot(subset_obj,
        features = relevant_genes,
        dot.scale = 6,
        cols = c("lightgray", "red"))  +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Top 10 Marker Genes - Original Clusters 2, 8, 13, 18, 22, 23, 26, 28",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%, yes QC",
    caption = "Mib1 KO vs control"
    )

# ggsave(dotPlot_original_clusters,
#        filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters.png"),
#        width = 32,
#        height = 8)
```

### Seurat clusters
```{r}
# Choose the clusters you want to plot
clusters_to_plot <- c(10, 11, 20, 21, 22, 23)

# Temporary subset — keep only cells from those clusters
subset_obj <- subset(re_embed_no_rbc_no_hb_yes_qc,
                     subset = seurat_clusters %in% clusters_to_plot)

# Set identity
Idents(subset_obj) <- "seurat_clusters"

# Filter top10_original_clusters to keep only genes that are markers for the selected clusters
relevant_genes <- top10_seurat_clusters %>%
  filter(cluster %in% clusters_to_plot) %>%
  pull(gene) %>%
  unique()

# Now make the DotPlot — only relevant genes
DotPlot(subset_obj,
        features = relevant_genes,
        dot.scale = 6,
        cols = c("lightgray", "red"))  +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(
    title = "Top 10 Marker Genes - Seurat Clusters 10, 11, 20, 21, 22, 23",
    subtitle = "Filtered: <10% MT, singlets only, no RBC, no Hb >0.22%, yes QC",
    caption = "Mib1 KO vs control"
    )

# ggsave(dotPlot_original_clusters,
#        filename = file.path(out_dir, "05-secondary_QC", "05-dotPlot_original_clusters.png"),
#        width = 32,
#        height = 8)
```

# Plot known cell markers

```{r}

FeaturePlot(re_embed_no_rbc,
            dims = c(1,2),
            features = c("Upk3b", "Upk1b"))

```

